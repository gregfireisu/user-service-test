<%- include('partials/header', { title: title, user: user }) %>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Управление пользователями</h2>
    <span class="badge bg-secondary">Роль: <%= user.role %></span>
</div>

<% if (user.role === 'admin') { %>
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Все пользователи</h5>
        </div>
        <div class="card-body">
            <% if (users && users.length > 0) { %>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ФИО</th>
                                <th>Email</th>
                                <th>Роль</th>
                                <th>Статус</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% users.forEach(userItem => { %>
                                <tr>
                                    <td><%= userItem._id %></td>
                                    <td><%= userItem.lastName %> <%= userItem.firstName %> <%= userItem.middleName || '' %></td>
                                    <td><%= userItem.email %></td>
                                    <td>
                                        <span class="badge bg-<%= userItem.role === 'admin' ? 'danger' : 'primary' %>">
                                            <%= userItem.role %>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-<%= userItem.isActive ? 'success' : 'danger' %>">
                                            <%= userItem.isActive ? 'Активен' : 'Заблокирован' %>
                                        </span>
                                    </td>
                                    <td>
                                        <% if (user.role === 'admin' || user._id === userItem._id) { %>
                                            <button class="btn btn-sm btn-<%= userItem.isActive ? 'warning' : 'success' %>"
                                                    onclick="toggleUserStatus('<%= userItem._id %>')">
                                                <%= userItem.isActive ? 'Заблокировать' : 'Активировать' %>
                                            </button>
                                        <% } %>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            <% } else { %>
                <p class="text-muted">Пользователи не найдены</p>
            <% } %>
        </div>
    </div>
<% } else { %>
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Мой профиль</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Имя:</strong> <%= user.firstName %></p>
                    <p><strong>Фамилия:</strong> <%= user.lastName %></p>
                    <% if (user.middleName) { %>
                        <p><strong>Отчество:</strong> <%= user.middleName %></p>
                    <% } %>
                    <p><strong>Email:</strong> <%= user.email %></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Роль:</strong> <span class="badge bg-primary"><%= user.role %></span></p>
                    <p><strong>Статус:</strong> 
                        <span class="badge bg-<%= user.isActive ? 'success' : 'danger' %>">
                            <%= user.isActive ? 'Активен' : 'Заблокирован' %>
                        </span>
                    </p>
                    <p><strong>Дата регистрации:</strong> <%= new Date(user.createdAt).toLocaleDateString() %></p>
                </div>
            </div>
            <button class="btn btn-<%= user.isActive ? 'warning' : 'success' %> mt-3"
                    onclick="toggleUserStatus('<%= user._id %>')">
                <%= user.isActive ? 'Заблокировать себя' : 'Активировать себя' %>
            </button>
        </div>
    </div>
<% } %>

<script>
async function toggleUserStatus(userId) {
    if (!confirm('Вы уверены, что хотите изменить статус пользователя?')) {
        return;
    }

    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/users/${userId}/toggle-status`, {
            method: 'PATCH',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            alert('Статус пользователя изменен');
            location.reload();
        } else {
            const result = await response.json();
            alert('Ошибка: ' + result.message);
        }
    } catch (error) {
        alert('Ошибка сети: ' + error.message);
    }
}
</script>

<%- include('partials/footer') %>